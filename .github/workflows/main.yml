on:
  push:
    branches:
      - main
name: Build
jobs:
  make:
    name: Build and Upload Sileo
    runs-on: macos-latest
    steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Select Xcode (latest stable)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show build environment
        run: |
          echo "Runner architecture: $RUNNER_ARCH"
          xcodebuild -version
          xcode-select -p

      - name: Setup Procursus Bootstrap (install)
        run: |
          if [ "$RUNNER_ARCH" = "ARM64" ]; then
            BOOTSTRAP_ARCH="darwin-arm64"
          else
            BOOTSTRAP_ARCH="darwin-amd64"
          fi
          BOOTSTRAP_FILE="bootstrap-${BOOTSTRAP_ARCH}.tar.zst"
          curl -L --fail --retry 3 -o "$BOOTSTRAP_FILE" "https://apt.procurs.us/bootstraps/big_sur/$BOOTSTRAP_FILE"
          TAR_BIN="$(command -v gtar || command -v tar)"
          sudo "$TAR_BIN" --preserve-permissions -xkf "./$BOOTSTRAP_FILE" -C /
          echo '/opt/procursus/sbin:/opt/procursus/bin' >> $GITHUB_PATH
          PATH=/opt/procursus/sbin:/opt/procursus/bin:$PATH sudo /opt/procursus/bin/apt update
          sudo /opt/procursus/bin/apt -V full-upgrade -y --allow-downgrades -oDpkg::Options::=--force-confdef -oDpkg::Options::=--force-confnew 
        continue-on-error: true
      
      - name: Upgrade
        run: |
          sudo /opt/procursus/bin/apt -V upgrade -y --allow-downgrades -oDpkg::Options::=--force-confdef -oDpkg::Options::=--force-confnew
    
      - name: Upgrade and install
        run: |
          sudo /opt/procursus/bin/apt install zstd apt-utils ldid xz-utils bzip2 lz4 -y --allow-downgrades -oDpkg::Options::=--force-confdef -oDpkg::Options::=--force-confnew
        
      - name: Add Procursus to PATH
        run: |
          echo '/opt/procursus/sbin:/opt/procursus/bin' >> $GITHUB_PATH

      - name: Build Sileo Nightly (iphoneos-arm64)
        run: |
          make clean
          xcodebuild -resolvePackageDependencies -project Sileo.xcodeproj -scheme Sileo -derivedDataPath "$TMPDIR/sileo"
          ALDERIS_FILE="$TMPDIR/sileo/SourcePackages/checkouts/Alderis/Alderis/ColorPickerInnerViewController.swift"
          if [ ! -f "$ALDERIS_FILE" ]; then
            echo "Alderis source file not found: $ALDERIS_FILE"
            exit 1
          fi
          if ! grep -q 'var pickerTab: ColorPickerTab' "$ALDERIS_FILE"; then
            sed -i '' 's/var tab: ColorPickerTab/var pickerTab: ColorPickerTab/' "$ALDERIS_FILE"
            sed -i '' 's/tab = configuration.initialTab/pickerTab = configuration.initialTab/' "$ALDERIS_FILE"
          fi
          LNPOPUP_PRIVATE_DIR="$TMPDIR/sileo/SourcePackages/checkouts/LNPopupController/LNPopupController/LNPopupController/Private"
          if [ ! -d "$LNPOPUP_PRIVATE_DIR" ]; then
            echo "LNPopup private directory not found: $LNPOPUP_PRIVATE_DIR"
            exit 1
          fi
          chmod -R u+w "$LNPOPUP_PRIVATE_DIR" || true
          for d in "$LNPOPUP_PRIVATE_DIR" "$LNPOPUP_PRIVATE_DIR"/*; do
            if [ -d "$d" ] && [ "$(basename "$d")" != "Utils" ]; then
              rel="Utils"
              if [ "$d" != "$LNPOPUP_PRIVATE_DIR" ]; then
                rel="../Utils"
              fi
              ln -sf "$rel/_LNPopupBase64Utils.hh" "$d/_LNPopupBase64Utils.hh"
              ln -sf "$rel/_LNPopupSwizzlingUtils.h" "$d/_LNPopupSwizzlingUtils.h"
              ln -sf "$rel/_LNPopupGlassUtils.h" "$d/_LNPopupGlassUtils.h"
            fi
          done
          LNPOPUP_FILE="$TMPDIR/sileo/SourcePackages/checkouts/LNPopupController/LNPopupController/LNPopupController/Private/Appearance/_LNPopupUIBarAppearanceProxy.mm"
          if [ ! -f "$LNPOPUP_FILE" ]; then
            echo "LNPopup source file not found: $LNPOPUP_FILE"
            exit 1
          fi
          LNPOPUP_DIR="$(dirname "$LNPOPUP_FILE")"
          chmod -R u+w "$LNPOPUP_DIR" || true
          if [ -f "$LNPOPUP_FILE" ] && [ ! -w "$LNPOPUP_FILE" ]; then
            chmod u+w "$LNPOPUP_FILE" || true
          fi
          rm -f "$LNPOPUP_FILE"
          cp .github/patches/_LNPopupUIBarAppearanceProxy.mm "$LNPOPUP_FILE"
          if ! grep -q '#import <objc/message.h>' "$LNPOPUP_FILE"; then
            echo "LNPopup patch verification failed (objc/message.h missing)."
            exit 1
          fi
          if ! grep -q 'superStruct.receiver = self;' "$LNPOPUP_FILE"; then
            echo "LNPopup patch verification failed (superStruct replacement missing)."
            exit 1
          fi
          make package NIGHTLY=1 DEBUG=0 ALL_BOOTSTRAPS=1 SILEO_PLATFORM=iphoneos-arm64 IOS_DEPLOYMENT_TARGET=13.0 V=1

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sileo-nightly-packages
          path: packages/*
